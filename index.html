<!DOCTYPE html>
<html lang="pt-br">
<meta charset="UTF-8">
<title>Balsa App</title>
<meta name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
<script src="dist/js/villa.min.js"></script>
<link rel="stylesheet" href="dist/css/villa.min.css"/>
<!--[if lt IE 9]>
<link rel="stylesheet" type="text/css" href="dist/css/material-colors.css"/>
<link rel="stylesheet" type="text/css" href="dist/css/villa-cross.min.css"/>
<script src="dist/js/html5shiv.js"></script>
<script src="dist/js/html5shiv-printshiv.js"></script>
<script src="dist/js/classList.min.js"></script>
<![endif]-->

<script id="firebase" src="https://www.gstatic.com/firebasejs/3.0.2/firebase.js" onload="isLoaded = true"></script>
<script src="dist/js/balsa-app.js"></script>

<script>

	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyCdPHyUfnfh9afBSv978w_Z7i96S03msos",
		authDomain: "balsa-app.firebaseapp.com",
		databaseURL: "https://balsa-app.firebaseio.com",
		storageBucket: "balsa-app.appspot.com"
	};

	firebase.initializeApp(config);

</script>

<script>

	window.onload = function () {
		var view = document.getElementById('balsa-app');
		var BalsaApp = new BalsaApp(view, firebase);
	};

</script>

<style>

	.BalsaApp {
		-webkit-align-items: center;
		align-items: center;
		display: -webkit-box;
		display: -moz-box;
		display: -ms-flexbox;
		display: -webkit-flex;
		display: flex;
		-webkit-flex-flow: column;
		flex-flow: column;
		height: 100vh;
		width: 100%;
		text-align: center;
	}

	.Header,
	.Counters,
	.Footer {
		flex: 1 1 auto;
		width: 100%;
	}

	.Header,
	.Footer {
		height: 100%;
	}

	.Header {
		max-height: 3em;
	}

	.Footer {
		max-height: 4.5em;
	}

</style>

<body>

<main id="balsa-app" class="BalsaApp font-green">

	<header class="Header"></header>

	<div class="Counters grey flex align-center justify-center"></div>

	<footer class="Footer">

		<button id="refresh"></button>

	</footer>

</main>

<script>
	// pull data from node
		//	usersRef.on('value', function (snap) {
		//		console.log(snap.val());
		//	});

	// push data to node
		// push() (create new id and push)
		// set() (update all nodes childs and delete all childs that isnt updated
		// update() (update only the nodes childs that is informed and keep others)
			// usersRef.push({
			// 	 facebook_id: result.user.uid,
			// 	 displayName: result.user.displayName,
			// 	 userPhoto: result.user.photoURL
			// });

	function toggleSignIn () {

		// check if there is an user signed in or not, if there is not, set a new FacebookAuthProvider (to initiate sign in flow), otherwise, sign out logged user
		if(!firebase.auth().currentUser) {

			var provider = new firebase.auth.FacebookAuthProvider();
			firebase.auth().signInWithRedirect(provider);

		} else {

			firebase.auth().signOut();

		}
	}

	function initApp () {
		var user = new User();

		// verify redirect result, if there is one, get user info; if there is error, get error info
		firebase.auth().getRedirectResult().then(function(result) {

			if(firebase.auth().currentUser !== null) {

				document.getElementById('refresh').innerHTML = "Sair";
			    user.setUserData(firebase.auth().currentUser);

				console.log("User logado");

				// save user only when sign in
				user.save(usersRef);

			}


		}).catch(function(error) {

			// handle authentication errors (ex. unable to connect usign email, etc)
			var errorCode = error.code;
			var errorMessage = error.message;
			var email = error.email;
			var credential = error.credential;

			console.error(error);
		});


		// listen for authStateChanged, if there is one user, set specific info and display info text, otherwise, there is no signed in user, do not display info
		firebase.auth().onAuthStateChanged(function(authUser) {

			// user is signed in, collect info from result and show them somehow
			if (authUser) {
				user.setUserData(authUser);
				console.log(user.getUserData());
				user.setSignInStatus(true);

//				firebase.auth().signOut();  // sign in every page reload
			} else {
				user.setSignInStatus(false);
				document.getElementById('refresh').innerHTML = "Entrar";
			}

		});

		// bind signin function to button that control user auth state
		document.getElementById('refresh').addEventListener('click', toggleSignIn, false);

	}



</script>

</body>

</html>