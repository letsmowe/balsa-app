<!DOCTYPE html>
<html lang="pt-br">
<meta charset="UTF-8">
<title>Balsa App</title>
<meta name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
<script src="dist/js/villa.min.js"></script>
<link rel="stylesheet" href="dist/css/villa.min.css"/>
<!--[if lt IE 9]>
<link rel="stylesheet" type="text/css" href="dist/css/material-colors.css"/>
<link rel="stylesheet" type="text/css" href="dist/css/villa-cross.min.css"/>
<script src="dist/js/html5shiv.js"></script>
<script src="dist/js/html5shiv-printshiv.js"></script>
<script src="dist/js/classList.min.js"></script>
<![endif]-->

<style>

	.BalsaApp {
		-webkit-align-items: center;
		align-items: center;
		display: -webkit-box;
		display: -moz-box;
		display: -ms-flexbox;
		display: -webkit-flex;
		display: flex;
		-webkit-flex-flow: column;
		flex-flow: column;
		padding: 0 1em;
		height: 100vh;
		width: 100%;
		text-align: center;
	}

	.Header {
		-webkit-align-items: center;
		align-items: center;
		display: -webkit-box;
		display: -moz-box;
		display: -ms-flexbox;
		display: -webkit-flex;
		display: flex;
		-webkit-justify-content: space-between;
		justify-content: space-between;
		width: 100%;
		height: 6em;
	}

	.SessionLogout,
	.BalsaApp.is-online .SessionLogin {
		display: none;
	}

	.SessionLogin,
	.BalsaApp.is-online .SessionLogout {
		display: block;
	}

</style>

<body>

<script>

//	window.fbAsyncInit = function() {
//		FB.init({
//			appId      : '238627553164073',
//			xfbml      : true,
//			version    : 'v2.6'
//		});
//	};
//
//	(function(d, s, id){
//		var js, fjs = d.getElementsByTagName(s)[0];
//		if (d.getElementById(id)) {return;}
//		js = d.createElement(s); js.id = id;
//		js.src = "//connect.facebook.net/en_US/sdk.js";
//		fjs.parentNode.insertBefore(js, fjs);
//	}(document, 'script', 'facebook-jssdk'));

</script>

<main id="main" class="BalsaApp font-green">

	<header class="Header">

		<img src="" alt="" id="session-img" class="SessionImage"/>

		<div id="session" class="Session"></div>

		<button id="login" class="SessionLogin">login</button>
		<button id="logout" class="SessionLogout">logout</button>

	</header>

	<span id="lblCount"></span>
	<input type="number" id="inCount"/>

	<span id="lblName"></span>
	<input type="text" id="inName"/>

</main>


<script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>

<script>

	// Firebase 'connection'
	var rootRef = new Firebase('https://balsa-app-test.firebaseio.com');
	var authData = rootRef.getAuth();

	function startCount() {

		var countRef = rootRef.child('count');

		countRef.on('value', function (snap) {

			document.getElementById('lblCount').innerHTML = snap.val();

		});
		
		document.getElementById('inCount').addEventListener('input', function () {

			var data = parseInt(this.value);

			countRef.set(data);

		});

	}

	function startName() {

		var nameRef = rootRef.child('name');

		nameRef.on('value', function (snap) {

			document.getElementById('lblName').innerHTML = snap.val();

		});

		document.getElementById('inName').addEventListener('input', function () {

			var data = this.value;
			nameRef.set(data);

		});

	}

	rootRef.onAuth(function (authData) {

		if (authData) {

			console.log("User " + authData.uid + " is logged in with " + authData.provider);

			rootRef.child("users").child(authData.uid).set(authData.facebook);
			rootRef.child("users").child(authData.uid).child('admin').set(true);

			document.getElementById('session').innerHTML = 'Olá ' + authData.facebook.displayName;
			document.getElementById('session-img').src = authData.facebook.profileImageURL;
			document.getElementById('main').classList.add('is-online');

		} else {

			console.log("User is logged out");

			document.getElementById('main').classList.remove('is-online');
			document.getElementById('session').innerHTML = 'você está offline ';

		}

		document.getElementById('login').addEventListener('click', function () {

			rootRef.authWithOAuthRedirect("facebook", function(error, authData) {

				if (error) {

					console.log("Login Failed!", error);

				} else {

					console.log("Authenticated successfully with payload:", authData);
					document.getElementById('main').classList.add('is-online');

				}

			}, {
				scope: "email,user_likes" // the permissions requested
			});

		});

		document.getElementById('logout').addEventListener('click', function () {

			rootRef.unauth();

		});

		startCount();
		startName();

	});

	// find a suitable name based on the meta info given by each provider
	function getName(authData) {
		switch(authData.provider) {
			case 'password':
				return authData.password.email.replace(/@.*/, '');
			case 'twitter':
				return authData.twitter.displayName;
			case 'facebook':
				return authData.facebook.displayName;
		}
	}

</script>

</body>

</html>